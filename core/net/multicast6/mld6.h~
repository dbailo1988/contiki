#ifndef __MLD6_H__
#define __MLD6_H__

#include "net/uip.h"
#include "sys/clock.h"

#ifndef MAX_NUM_OF_MCAST6_GROUPS
#define MAX_NUM_OF_MCAST6_GROUPS 2
#endif

#ifndef MAX_NUM_OF_MCAST_LISTENING
#define MAX_NUM_OF_MCAST_LISTENING 4
#endif

/*MLD constants*/

#define ROBUSTNESS_VARIABLE 2
#define QUERY_INTERVAL 125 /*seconds within periodical general queries*/
#define QUERY_RESPONSE_INTERVAL 10
#define MCAST_LISTENER_INTERVAL (ROBUSTNESS_VARIABLE x QUERY_INTERVAL)+ QUERY_RESPONSE_INTERVAL
/* time to decide there is no more listeners for an address*/
#define OTHER_QUERIER_INTERVAL	(ROBUSTNESS_VARIABLE x QUERY_INTERVAL)+ (QUERY_RESPONSE_INTERVAL/2)
/*time to decide there is no querier routers*/
#define START_QI (QUERY_INTERVAL/4)
#define START_COUNT ROBUSTNESS_VARIABLE
#define LAST_LISTENER_QI 1
#define COUNT_LAST_LISTENER ROBUSTNESS_VARIABLE
#define UNSOLICITED REPORT INTERVAL 10

/* Node States*/

#define DELAYING_LISTENER 0
#define IDLE_LISTENER 1

/* Router States*/

#define NO_LISTENERS 0
#define LISTENERS 1
#define CHECKING_LISTENERS 2

/* Struct for nodes*/

struct mld6_listen_group {
	int used;
	uint8_t mld_flag; /* Whether there is more listeners than you*/
	uint8_t state;
	uip_ipaddr_t mcast_group;
	uip_ipaddr_t source; /* Source-filthering*/
	uip_ipaddr_t preferred_parent; /* from which link-local router receive packet */
	struct ctimer *delay_timer; /* [0, Max.Respons.Delay] */
};

typedef struct mld6_listen_group mld6_listen_group_t;

//List or array of mld6_groups, as structs as number of mcast groups listening

struct mcast_group {
	int used;
	uip_ipaddr_t mcast_group;
	uip_ipaddr_t source;
	uint8_t state;
	struct ctimer *timer;
	struct ctimer *rtx_timer;
};

typedef struct mcast_group mcast_group_t;

/*
    Functions to send MLD packets
*/

void mld_gen_query();
void mld_mas_query(uip_ipaddr_t *group_addr, uip_ipaddr_t *source_addr);
void mld_report(uip_ipaddr_t *group_addr, uip_ipaddr_t *source_addr, uip_ipaddr_t *preferred_parent);
void mld_done(uip_ipaddr_t *group_addr, uip_ipaddr_t *source_addr, uip_ipaddr_t *preferred_parent);

/*
 *   Functions to work with Multicast groups in routers
 */

#ifdef UIP_CONF_ROUTER
mcast_group_t *mcast_group_new(uip_ipaddr_t *group_addr,uip_ipaddr_t *source_addr);
mcast_group_t *mcast_group_find (uip_ipaddr_t *group_addr, uip_ipaddr_t *source_addr);
void print_mld_router_table();
#endif
/*
 *   Functions to work with listeners_group in nodes
 */
#ifdef RPL_CONF_LEAF_ONLY
mld6_listen_group_t *new_listener(uip_ipaddr_t *group_addr, uip_ipaddr_t *source, uip_ipaddr_t *preferred_parent);
mld6_listen_group_t *find_listener (uip_ipaddr_t *group_addr, uip_ipaddr_t *source);
int erase_listener (uip_ipaddr_t *group_addr, uip_ipaddr_t *source, uip_ipaddr_t *preferred_parent);
void print_mld_node_table();
#endif

/*
 * 	Handlers for MLD messages
 */

void mld_query_in();
void mld_report_in();
void mld_done_in();

#endif /* __MLD6_H__ */
